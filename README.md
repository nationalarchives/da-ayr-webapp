# da-ayr-webapp
The webapp code for the Access Your Records (AYR) project.

This project consists of a Django application with a Postgres backend. Authentication and authorisation are handled
by Keyloack using Open ID Connect protocol.

# Running the app locally
The .env file below seems to work for Mac.  For Linux, some extra work is required.  See below

Also be aware, you cannot add the ```OIDC_RP_CLIENT_ID``` until Keycloak has started for the first time and it has been generated by the user.

### Environment variables

Some app configuration settings are loaded via environment variables.
You need to create a `.env`file and add the following entries to it.


`SECRET_KEY=your-secret-key`

You can generate a secret-key with a password manage or a free online secret key generator service
(e.g https://miniwebtool.com/django-secret-key-generator).

Minimum length should be 50 chars. It should include alphanumeric values and symbols.

`KEYCLOAK_BASE_URI=http://kubernetes.docker.internal:8080`

`KEYCLOAK_REALM_NAME=ayr`

`OIDC_RP_CLIENT_ID=webapp`

`OIDC_RP_CLIENT_SECRET=your-client-secret`
This value needs to be copied from the Open ID Client created in Keycloak


`KEYCLOAK_DB_NAME=keycloak`

`KEYCLOAK_DB_USER=keycloak`

`KEYCLOAK_DB_PASSWORD=your-keycloak-db-password`

`KEYCLOAK_ADMIN=admin`

`KEYCLOAK_ADMIN_PASSWORD=your-keycloak-admin-password`

`WEBAPP_DB_NAME=django`

`WEBAPP_DB_USER=django`

`WEBAPP_DB_PASSWORD=yopur-webapp-db-password`

### Linux
```docker.internal``` is not setup on Docker for Linux.  
One possible solution is to use:

```KEYCLOAK_BASE_URI=http://keycloak:8080```

And to set a hostname in ```/etc/hosts``` for ```keycloak``` 

Using this hostname will resolve for the host machine and for hosts in the Docker network

Also note, disabling the lines in docker-compose.yaml
```
#    volumes:
#      - .keycloak_data:/opt/keycloak/data
```
may also be required to get Keycloak to start

### Build and run

    make up

Alias for

    docker compose up --build

This will build and run the Django app available at `http://localhost:8000` and the Keycloak server available at `http://keycloak:8080`, alias for `http://localhost:8000`.
If you are running the app for the first time you will need to run migrations beforehand.

    make migrate

or 

```docker-compose exec web python manage.py migrate```

## Keycloak setup

Login to Keycloak using your admin credentials.

### Create ayr realm
- From the admin panel create a new realm called `ayr`.

### Create client in ayr realm
Once in the new realm (the default is called `admin`), create a new client with the following settings
#### General settings

`Client type = Open ID Connect`

`Client ID = webapp`
#### Capability config

Set `Client authentication` to On.


#### Login settings

Fill the fields `Valid redirect URIs`, `Valid post logout redirect URIs`, `Web origins` with the value `http://localhost:8000/*`.

Save the changes.
## Create a new user

Create a new user in the ayr realm with email. In the credentials tab create a new password.
## Authentication flow

Navigate to http://localhost:8000.

Click on the `login` button.

You will be redirected to keycloak for the authentication.
Enter the newly created user credentials and press enter.

You should now be redirected to Django app index and see a `logout` button.

# Local Development
Create a new virtual environment for this project, then

    pip install pip-tools

See also Dependency Management section.

After installing `pip-tools`

    pip install -r requirements-dev.txt


# Dependency Management

This project is using [pip-tools](https://github.com/jazzband/pip-tools/) for dependency management.

Install it in your local virtual env

    pip install pip-tools

All dependencies should be declared and pinned in `pyproject.toml`

To generate a new `requirements.txt` file

    pip-compile -o requirements.txt pyproject.toml

To generate a new dev requirements.txt file

    pip-compile --extra dev -o requirements-dev.txt pyproject.toml
